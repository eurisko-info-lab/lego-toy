-----------------------------------------------------
-- lego2rosetta.lego: Translator from Lego to Rosetta
--
-- This file defines the translator in Lego syntax, leveraging meta-circularity.
-----------------------------------------------------
import Lego
import Rosetta

lang LegoToRosetta (Lego Rosetta) :=

-----------------------------------------------------
-- TransformPrimitives
-- Basic transformation rules for terms.
-----------------------------------------------------
piece TransformPrimitives
  rule transformTermApp: (transform ($func $args)) ~~> ($transformedFunc (transform $args))
    when $transformedFunc = (capitalize $func) ;
  rule transformTermLit: (transform $lit) ~~> (Const $lit)
    when (isLiteral $lit) ;
  rule transformTermVar: (transform $var) ~~> (Var $var) ;
  rule transformTermIdent: (transform $id) ~~> (Ident $id)
    when (isIdent $id) ;
  rule transformPat: (transformPat $pat) ~~> (transform $pat) ;

-----------------------------------------------------
-- RuleTransform
-- Transform rule AST to rewriteRule.
-----------------------------------------------------
piece RuleTransform
  rule transformRule: (transform (DRule $name $body)) ~~> (rewriteRule $name (transform $body)) ;

-----------------------------------------------------
-- TypeTransform
-- Transform type judgment AST to judgeDecl.
-----------------------------------------------------
piece TypeTransform
  rule transformType: (transform (DType $name $body)) ~~> (judgeDecl $name (transform $body)) ;

-----------------------------------------------------
-- TestTransform
-- Pass through test AST with term transformation.
-----------------------------------------------------
piece TestTransform
  rule transformTest: (transform (DTest $name $body)) ~~> (testDecl $name (transform $body)) ;

-----------------------------------------------------
-- PieceTransform
-- Transform piece AST to moduleDecl.
-----------------------------------------------------
piece PieceTransform
  rule transformPiece: (transform (DPiece $name $decls)) ~~> (moduleDecl $name (transform $decls)) ;
  rule transformImport: (transform (DImport $mod)) ~~> (importDecl $mod) ;

-----------------------------------------------------
-- LangTransform
-- Top-level transformation.
-----------------------------------------------------
piece LangTransform
  rule transformLang: (transform (DLang $name $contents)) ~~> (lang $name (transform $contents)) ;

-----------------------------------------------------
-- ContextHelpers
-- Meta-rules for context.
-----------------------------------------------------
piece ContextHelpers
  rule capitalize: (capitalize $str) ~~> $upperStr ;
  rule concat: (concat $a $b) ~~> $combined ;

-----------------------------------------------------
-- Examples
-----------------------------------------------------
test "transformVarEx": (transform $x) ~~> (Var $x) ;
test "transformAppEx": (transform (f $a)) ~~> (F (transform $a)) ;
